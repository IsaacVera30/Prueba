<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Monitoreo de Salud - Entrenamiento Corregido</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            padding: 20px; 
            background-color: #f7f7f7; 
        }
        h1, h2 { 
            color: #333; 
            border-bottom: 2px solid #eee; 
            padding-bottom: 10px;
        }
        .container { 
            background-color: white; 
            border: 1px solid #e0e0e0; 
            padding: 15px 20px; 
            margin-bottom: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        }
        p { 
            font-size: 1.1em; 
            color: #555; 
            line-height: 1.6; 
        }
        strong { 
            color: #000; 
            font-weight: 600; 
            float: right; 
        }
        button { 
            padding: 10px 15px; 
            border-radius: 5px; 
            border: 1px solid #ccc; 
            color: #333; 
            background-color: #fff; 
            cursor: pointer; 
            font-size: 1em; 
            margin-right: 10px; 
            margin-top: 5px; 
        }
        button:hover:not(:disabled) { 
            background-color: #e9ecef; 
        }
        button:disabled { 
            background-color: #f8f9fa; 
            color: #6c757d; 
            cursor: not-allowed; 
        }
        button.active {
            background-color: #28a745;
            color: white;
        }
        button.stop {
            background-color: #dc3545;
            color: white;
        }
        input[type="number"] { 
            padding: 8px; 
            border-radius: 5px; 
            border: 1px solid #ccc; 
            margin-left: 5px; 
            width: 80px; 
        }
        input:disabled { 
            background-color: #e9ecef; 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px;
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 12px; 
            text-align: left; 
        }
        th { 
            background-color: #f8f9fa; 
        }
        .training-subsection { 
            display: none; 
            margin-top: 15px; 
            border-top: 1px solid #eee; 
            padding-top: 15px; 
        }
        .form-group > * { 
            margin-right: 15px; 
        }
        .status-active {
            color: #28a745;
            font-weight: bold;
        }
        .status-capturing {
            color: #ffc107;
            font-weight: bold;
        }
        .status-ready {
            color: #17a2b8;
            font-weight: bold;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <h1>Panel de Monitoreo de Salud</h1>

    <div class="container">
        <h2>Lecturas del Sensor</h2>
        <p>IR: <strong id="ir">---</strong></p>
        <p>RED: <strong id="red">---</strong></p>
    </div>

    <div class="container">
        <h2>Prediccion ML</h2>
        <p>SYS ML: <strong id="sys">---</strong> mmHg</p>
        <p>DIA ML: <strong id="dia">---</strong> mmHg</p>
        <p>HR ML: <strong id="hr">---</strong> bpm</p>
        <p>SpO2 ML: <strong id="spo2">---</strong> %</p>
        <p>Estado: <strong id="nivel">---</strong></p>
        <p>Muestras: <strong id="muestras_count">---</strong></p>
    </div>

    <div class="container">
        <h2>Entrenamiento ML CORREGIDO</h2>
        <p><strong>Instrucciones:</strong></p>
        <ol>
            <li>Active el modo entrenamiento</li>
            <li>Mantenga el dedo estable en el sensor</li>
            <li>Espere 5 segundos (estabilizacion)</li>
            <li>Encienda el tensiometro en el otro brazo</li>
            <li>NO mueva ninguno de los dos brazos durante la medicion</li>
            <li>Cuando termine el tensiometro, mantenga dedo 5 segundos mas</li>
            <li>Detenga manualmente e ingrese valores de referencia</li>
        </ol>
        
        <button id="authTrainingBtn">ACTIVAR Modo Entrenamiento</button>
        
        <div id="training-subsection" class="training-subsection">
            <div style="margin: 15px 0;">
                <button id="startMeasurementBtn" disabled>Tensiómetro ENCENDIDO</button>
                <button id="finishMeasurementBtn" disabled>Tensiómetro TERMINÓ</button>
                <button id="stopTrainingBtn" disabled class="stop">DETENER Entrenamiento</button>
            </div>
            
            <div style="margin: 15px 0;">
                <span id="training-status" class="status-active">Inactivo</span>
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill" style="width: 0%;"></div>
                </div>
                <div id="phase-info">---</div>
            </div>
            
            <div style="margin-top: 15px;">
                <p><strong>Valores de Referencia del Tensiómetro:</strong></p>
                <div class="form-group">
                    <label>SYS: <input type="number" id="sysRef" disabled min="70" max="250"></label>
                    <label>DIA: <input type="number" id="diaRef" disabled min="40" max="150"></label>
                    <label>HR: <input type="number" id="hrRef" disabled min="40" max="200"></label>
                </div>
            </div>
            <button id="saveSampleBtn" style="margin-top: 15px; background-color: #28a745; color: white;" disabled>GUARDAR en Google Drive</button>
        </div>
    </div>

    <div class="container">
        <h2>Ultimos 20 datos registrados</h2>
        <button onclick="actualizarTablaMediciones()" style="margin-bottom: 10px;">Actualizar Tabla</button>
        <table id="medicionesTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>PACIENTE ID</th>
                    <th>SYS ML</th>
                    <th>DIA ML</th>
                    <th>HR ML</th>
                    <th>SpO2 ML</th>
                    <th>Nivel</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="7" style="text-align:center;">Cargando...</td></tr>
            </tbody>
        </table>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const ui = {
                // Lecturas del sensor
                ir: document.getElementById('ir'),
                red: document.getElementById('red'),
                
                // Prediccion ML
                sys: document.getElementById('sys'),
                dia: document.getElementById('dia'),
                hr: document.getElementById('hr'),
                spo2: document.getElementById('spo2'),
                nivel: document.getElementById('nivel'),
                muestras_count: document.getElementById('muestras_count'),
                
                // Entrenamiento CORREGIDO
                authTrainingBtn: document.getElementById('authTrainingBtn'),
                trainingSubsection: document.getElementById('training-subsection'),
                startMeasurementBtn: document.getElementById('startMeasurementBtn'),
                finishMeasurementBtn: document.getElementById('finishMeasurementBtn'),
                stopTrainingBtn: document.getElementById('stopTrainingBtn'),
                saveSampleBtn: document.getElementById('saveSampleBtn'),
                trainingStatus: document.getElementById('training-status'),
                progressFill: document.getElementById('progress-fill'),
                phaseInfo: document.getElementById('phase-info'),
                sysRef: document.getElementById('sysRef'),
                diaRef: document.getElementById('diaRef'),
                hrRef: document.getElementById('hrRef'),
                
                // Tabla
                medicionesTbody: document.getElementById('medicionesTable').querySelector('tbody')
            };

            // Estado del entrenamiento
            let trainingState = {
                active: false,
                phase: 'idle', // idle, stabilizing, ready_for_measurement, measuring, waiting, ready_to_save
                startTime: null,
                totalSamples: 0
            };

            let socket;

            // Inicializar Socket.IO
            function initializeSocket() {
                try {
                    socket = io();
                    
                    socket.on('connect', () => {
                        console.log('Conectado al servidor Socket.IO');
                    });
                    
                    socket.on('disconnect', () => {
                        console.log('Desconectado del servidor Socket.IO');
                    });

                    // Evento principal para actualizacion de datos
                    socket.on('update_data', function(data) {
                        console.log('Datos recibidos:', data);
                        
                        // Actualizar valores del sensor
                        if (data.ir !== undefined) ui.ir.textContent = data.ir;
                        if (data.red !== undefined) ui.red.textContent = data.red;
                        
                        // Actualizar predicciones ML
                        if (data.sys !== undefined) ui.sys.textContent = parseFloat(data.sys).toFixed(1);
                        if (data.dia !== undefined) ui.dia.textContent = parseFloat(data.dia).toFixed(1);
                        if (data.hr !== undefined) ui.hr.textContent = Math.round(data.hr);
                        if (data.spo2 !== undefined) ui.spo2.textContent = Math.round(data.spo2);
                        if (data.nivel !== undefined) ui.nivel.textContent = data.nivel;
                        if (data.muestras_recolectadas !== undefined) {
                            ui.muestras_count.textContent = data.muestras_recolectadas + "/50";
                        }
                    });

                    socket.on('new_record_saved', () => {
                        console.log('Nuevo registro guardado');
                        actualizarTablaMediciones();
                    });
                    
                } catch (error) {
                    console.error('Error inicializando Socket.IO:', error);
                }
            }

            function updateTrainingUI() {
                // Mostrar/ocultar subsección
                ui.trainingSubsection.style.display = trainingState.active ? 'block' : 'none';
                
                // Botón principal
                ui.authTrainingBtn.textContent = trainingState.active ? 'DESACTIVAR Modo Entrenamiento' : 'ACTIVAR Modo Entrenamiento';
                ui.authTrainingBtn.className = trainingState.active ? 'active' : '';
                
                if (trainingState.active) {
                    // Actualizar estado según fase
                    switch(trainingState.phase) {
                        case 'stabilizing':
                            ui.trainingStatus.textContent = 'ESTABILIZANDO (5 segundos)';
                            ui.trainingStatus.className = 'status-capturing';
                            ui.phaseInfo.textContent = 'Mantenga dedo estable. NO encienda tensiómetro aún.';
                            ui.startMeasurementBtn.disabled = true;
                            ui.finishMeasurementBtn.disabled = true;
                            ui.stopTrainingBtn.disabled = false;
                            break;
                            
                        case 'ready_for_measurement':
                            ui.trainingStatus.textContent = 'LISTO PARA TENSIÓMETRO';
                            ui.trainingStatus.className = 'status-ready';
                            ui.phaseInfo.textContent = 'Ahora ENCIENDA el tensiómetro y presione el botón.';
                            ui.startMeasurementBtn.disabled = false;
                            ui.finishMeasurementBtn.disabled = true;
                            ui.stopTrainingBtn.disabled = false;
                            break;
                            
                        case 'measuring':
                            ui.trainingStatus.textContent = 'MIDIENDO (No mover)';
                            ui.trainingStatus.className = 'status-capturing';
                            ui.phaseInfo.textContent = 'Tensiómetro funcionando. NO mover brazos.';
                            ui.startMeasurementBtn.disabled = true;
                            ui.finishMeasurementBtn.disabled = false;
                            ui.stopTrainingBtn.disabled = false;
                            break;
                            
                        case 'waiting':
                            ui.trainingStatus.textContent = 'ESPERANDO (5 segundos más)';
                            ui.trainingStatus.className = 'status-capturing';
                            ui.phaseInfo.textContent = 'Mantenga dedo 5 segundos más.';
                            ui.startMeasurementBtn.disabled = true;
                            ui.finishMeasurementBtn.disabled = true;
                            ui.stopTrainingBtn.disabled = false;
                            break;
                            
                        case 'ready_to_save':
                            ui.trainingStatus.textContent = 'LISTO PARA GUARDAR';
                            ui.trainingStatus.className = 'status-ready';
                            ui.phaseInfo.textContent = 'Ingrese valores del tensiómetro y guarde.';
                            ui.startMeasurementBtn.disabled = true;
                            ui.finishMeasurementBtn.disabled = true;
                            ui.stopTrainingBtn.disabled = false;
                            ui.sysRef.disabled = false;
                            ui.diaRef.disabled = false;
                            ui.hrRef.disabled = false;
                            ui.saveSampleBtn.disabled = false;
                            break;
                    }
                    
                    // Calcular progreso aproximado
                    let progress = 0;
                    switch(trainingState.phase) {
                        case 'stabilizing': progress = 20; break;
                        case 'ready_for_measurement': progress = 30; break;
                        case 'measuring': progress = 60; break;
                        case 'waiting': progress = 80; break;
                        case 'ready_to_save': progress = 100; break;
                    }
                    ui.progressFill.style.width = progress + '%';
                    
                } else {
                    ui.trainingStatus.textContent = 'Inactivo';
                    ui.trainingStatus.className = 'status-active';
                    ui.phaseInfo.textContent = '---';
                    ui.progressFill.style.width = '0%';
                    
                    // Deshabilitar todos los controles
                    ui.startMeasurementBtn.disabled = true;
                    ui.finishMeasurementBtn.disabled = true;
                    ui.stopTrainingBtn.disabled = true;
                    ui.sysRef.disabled = true;
                    ui.diaRef.disabled = true;
                    ui.hrRef.disabled = true;
                    ui.saveSampleBtn.disabled = true;
                }
            }

            // EVENTOS DE ENTRENAMIENTO

            ui.authTrainingBtn.addEventListener('click', () => {
                if (!trainingState.active) {
                    // ACTIVAR entrenamiento
                    console.log('Activando modo entrenamiento...');
                    
                    fetch('/api/start_capture', { method: 'POST' })
                        .then(res => res.json())
                        .then(data => {
                            console.log('Respuesta start_capture:', data);
                            if (data.success || data.status === 'success') {
                                trainingState.active = true;
                                trainingState.phase = 'stabilizing';
                                trainingState.startTime = Date.now();
                                trainingState.totalSamples = 0;
                                
                                // Simular progreso de estabilización
                                setTimeout(() => {
                                    if (trainingState.active && trainingState.phase === 'stabilizing') {
                                        trainingState.phase = 'ready_for_measurement';
                                        updateTrainingUI();
                                    }
                                }, 5000);
                                
                                updateTrainingUI();
                            } else {
                                alert('Error activando entrenamiento: ' + (data.error || 'Error desconocido'));
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Error de conexión al activar entrenamiento');
                        });
                        
                } else {
                    // DESACTIVAR entrenamiento
                    console.log('Desactivando modo entrenamiento...');
                    
                    fetch('/api/stop_capture', { method: 'POST' })
                        .then(res => res.json())
                        .then(data => {
                            console.log('Respuesta stop_capture:', data);
                            trainingState.active = false;
                            trainingState.phase = 'idle';
                            
                            // Limpiar campos
                            ui.sysRef.value = '';
                            ui.diaRef.value = '';
                            ui.hrRef.value = '';
                            
                            updateTrainingUI();
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            // Desactivar de todas formas
                            trainingState.active = false;
                            trainingState.phase = 'idle';
                            updateTrainingUI();
                        });
                }
            });

            ui.startMeasurementBtn.addEventListener('click', () => {
                if (trainingState.phase === 'ready_for_measurement') {
                    console.log('Iniciando fase de medición...');
                    trainingState.phase = 'measuring';
                    updateTrainingUI();
                }
            });

            ui.finishMeasurementBtn.addEventListener('click', () => {
                if (trainingState.phase === 'measuring') {
                    console.log('Finalizando medición...');
                    trainingState.phase = 'waiting';
                    
                    // Simular 5 segundos de espera
                    setTimeout(() => {
                        if (trainingState.active && trainingState.phase === 'waiting') {
                            trainingState.phase = 'ready_to_save';
                            updateTrainingUI();
                        }
                    }, 5000);
                    
                    updateTrainingUI();
                }
            });

            ui.stopTrainingBtn.addEventListener('click', () => {
                console.log('Deteniendo entrenamiento manualmente...');
                
                fetch('/api/stop_capture', { method: 'POST' })
                    .then(res => res.json())
                    .then(data => {
                        console.log('Entrenamiento detenido:', data);
                        if (data.success || data.status === 'success') {
                            trainingState.phase = 'ready_to_save';
                            updateTrainingUI();
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        trainingState.phase = 'ready_to_save';
                        updateTrainingUI();
                    });
            });

            ui.saveSampleBtn.addEventListener('click', () => {
                const refData = { 
                    sys_ref: parseInt(ui.sysRef.value), 
                    dia_ref: parseInt(ui.diaRef.value), 
                    hr_ref: parseInt(ui.hrRef.value)
                };
                
                if (!refData.sys_ref || !refData.dia_ref || !refData.hr_ref) {
                    alert("Por favor, ingrese todos los valores de referencia.");
                    return;
                }
                
                if (refData.sys_ref < 70 || refData.sys_ref > 250) {
                    alert("SYS debe estar entre 70 y 250 mmHg");
                    return;
                }
                
                if (refData.dia_ref < 40 || refData.dia_ref > 150) {
                    alert("DIA debe estar entre 40 y 150 mmHg");
                    return;
                }
                
                if (refData.hr_ref < 40 || refData.hr_ref > 200) {
                    alert("HR debe estar entre 40 y 200 bpm");
                    return;
                }
                
                console.log('Guardando datos de entrenamiento:', refData);
                
                fetch('/api/save_training_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(refData)
                })
                .then(res => res.json())
                .then(data => {
                    console.log('Respuesta guardar:', data);
                    if (data.success || data.status === 'success') {
                        alert("Datos guardados exitosamente en Google Drive!");
                        
                        // Resetear entrenamiento
                        trainingState.active = false;
                        trainingState.phase = 'idle';
                        ui.sysRef.value = '';
                        ui.diaRef.value = '';
                        ui.hrRef.value = '';
                        updateTrainingUI();
                        
                    } else {
                        alert("Error al guardar: " + (data.error || "Error desconocido"));
                    }
                })
                .catch(error => {
                    console.error('Error guardando:', error);
                    alert("Error de conexión al guardar");
                });
            });

            // Función para actualizar tabla de mediciones
            window.actualizarTablaMediciones = function() {
                console.log('Actualizando tabla de mediciones...');
                
                fetch('/api/mediciones_recientes?limit=20')
                    .then(res => {
                        if (!res.ok) {
                            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                        }
                        return res.json();
                    })
                    .then(data => {
                        console.log('Datos de mediciones:', data);
                        const tbody = ui.medicionesTbody;
                        tbody.innerHTML = '';
                        
                        if (data.success && data.mediciones && data.mediciones.length > 0) {
                            data.mediciones.forEach(med => {
                                let row = tbody.insertRow();
                                row.insertCell().textContent = med.id || '---';
                                row.insertCell().textContent = med.patient_id || med.id_paciente || '---';
                                row.insertCell().textContent = med.sys ? parseFloat(med.sys).toFixed(1) : '---';
                                row.insertCell().textContent = med.dia ? parseFloat(med.dia).toFixed(1) : '---';
                                row.insertCell().textContent = med.hr ? Math.round(med.hr) : '---';
                                row.insertCell().textContent = med.spo2 ? Math.round(med.spo2) : '---';
                                row.insertCell().textContent = med.nivel || '---';
                            });
                        } else {
                            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No hay datos disponibles.</td></tr>';
                        }
                    })
                    .catch(error => {
                        console.error('Error cargando mediciones:', error);
                        ui.medicionesTbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Error cargando datos: ' + error.message + '</td></tr>';
                    });
            };

            // Inicializar aplicación
            console.log('Inicializando aplicación corregida...');
            updateTrainingUI();
            initializeSocket();
            actualizarTablaMediciones();
            
            // Auto-actualizar tabla cada 30 segundos
            setInterval(actualizarTablaMediciones, 30000);
        });
    </script>
</body>
</html>
